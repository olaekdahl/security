services:
  mongo-insecure:
    image: mongo:7
    container_name: mongo-insecure
    profiles: ["insecure"]
    ports:
      - "27017:27017"
    command: ["mongod", "--bind_ip_all"]
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "mongodb://localhost:27017/admin", "--eval", "db.runCommand({ ping: 1 })"]
      interval: 5s
      timeout: 3s
      retries: 20

  mongo-secure:
    image: mongo:7
    container_name: mongo-secure
    profiles: ["secure"]
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: ChangeMe_LongRandom
    command: ["mongod", "--auth", "--bind_ip_all"]
    volumes:
      - ./mongo/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "mongodb://admin:ChangeMe_LongRandom@localhost:27017/admin", "--eval", "db.runCommand({ ping: 1 })"]
      interval: 5s
      timeout: 3s
      retries: 20

  app:
    build:
      context: ./app
    container_name: mongo-demo-app
    profiles: ["insecure", "secure"]
    depends_on:
      mongo-insecure:
        condition: service_healthy
      mongo-secure:
        condition: service_healthy
    ports:
      - "3000:3000"
    environment:
      PORT: "3000"
    # MONGO_URL + VALIDATION_MODE are set per-profile with overrides below
    command: ["node", "src/server.js"]

  app-insecure:
    extends:
      service: app
    profiles: ["insecure"]
    environment:
      PORT: "3000"
      MONGO_URL: "mongodb://mongo-insecure:27017"
      VALIDATION_MODE: "off"

  app-secure:
    extends:
      service: app
    profiles: ["secure"]
    environment:
      PORT: "3000"
      # Least-privileged user created by init script
      MONGO_URL: "mongodb://app_user:ChangeMe_AppUser_LongRandom@mongo-secure:27017/appdb?authSource=appdb"
      VALIDATION_MODE: "on"
